# 语音转文字（STT - Speech to Text）功能使用说明

## 📋 功能概述

已实现语音转文字功能，支持使用笔记本自带麦克风进行录音，并将语音转换为文字描述。

## 🎯 使用方法

### 步骤1：录音

1. 在界面中找到"🎤 语音输入"区域
2. 点击"🎙️ 录音（点击开始/结束）"按钮
3. 开始说话（系统会开始录音）
4. 再次点击录音按钮结束录音

### 步骤2：识别语音

1. 录音完成后，点击"🎯 识别语音"按钮
2. 系统会调用API将音频转换为文字
3. 识别的文字会显示在"📝 识别的文字"文本框中
4. **识别的文字会自动填入下方的文字输入框**

### 步骤3：生成图片

1. 确认识别的文字正确（可以手动编辑）
2. 点击"✨ 生成图片"按钮
3. 等待图片生成完成

## 🔧 技术实现

### API调用

**API地址**: `https://www.dmxapi.cn/v1/audio/transcriptions`

**请求格式**:
```python
POST /v1/audio/transcriptions
Headers:
  Authorization: Bearer {API_KEY}
Data:
  model: gpt-4o-transcribe
Files:
  file: audio.mp3
```

**响应格式**:
```json
{
  "text": "识别的文字内容"
}
```

### 代码位置

- **API服务**: `doubao_service.py` - `audio_to_text()` 方法
- **界面处理**: `app.py` - `process_audio()` 函数
- **配置**: `config.py` - `STT_URL` 配置项

## ⚙️ 配置说明

### 环境变量

在 `.env` 文件中配置：

```env
DMX_API_KEY=your_api_key_here
STT_URL=https://www.dmxapi.cn/v1/audio/transcriptions  # 可选，有默认值
```

### 默认配置

- **STT_URL**: `https://www.dmxapi.cn/v1/audio/transcriptions`
- **模型**: `gpt-4o-transcribe`
- **音频格式**: MP3（Gradio自动转换）

## 🐛 常见问题

### Q1: 录音按钮没有反应

**可能原因**:
- 浏览器未授权麦克风权限
- 麦克风设备未连接

**解决方法**:
1. 检查浏览器是否允许麦克风访问
2. 确认麦克风设备正常工作
3. 刷新页面重新授权

### Q2: 识别失败或返回空文字

**可能原因**:
- API密钥无效
- 网络连接问题
- 音频格式不支持
- 录音时间太短或没有声音

**解决方法**:
1. 检查 `.env` 文件中的 `DMX_API_KEY` 是否正确
2. 检查网络连接
3. 确保录音有声音内容
4. 查看控制台错误信息

### Q3: 识别的文字不准确

**可能原因**:
- 环境噪音太大
- 说话声音太小
- 语言或方言不支持

**解决方法**:
1. 在安静环境中录音
2. 靠近麦克风，清晰发音
3. 使用标准普通话

### Q4: 音频文件格式问题

**说明**:
- Gradio的Audio组件会自动处理格式转换
- 如果遇到格式问题，可以尝试：
  1. 使用Chrome浏览器（兼容性最好）
  2. 检查浏览器是否支持Web Audio API

## 📊 数据流

```
用户点击录音按钮
    ↓
Gradio Audio组件录音
    ↓
录音完成，生成音频文件
    ↓
用户点击"识别语音"按钮
    ↓
process_audio() 函数处理
    ↓
调用 doubao_service.audio_to_text()
    ↓
发送POST请求到STT API
    ↓
解析响应，获取文字
    ↓
显示在"识别的文字"文本框
    ↓
自动填入"文字输入"框
    ↓
用户可以编辑或直接生成图片
```

## ✅ 功能验证

### 测试步骤

1. **录音测试**:
   - ✅ 点击录音按钮，开始录音
   - ✅ 说话几秒钟
   - ✅ 再次点击结束录音
   - ✅ 音频文件生成成功

2. **识别测试**:
   - ✅ 点击"识别语音"按钮
   - ✅ 等待API响应
   - ✅ 文字显示在文本框中
   - ✅ 文字自动填入输入框

3. **完整流程测试**:
   - ✅ 录音 → 识别 → 生成图片
   - ✅ 整个流程顺畅无错误

## 🔄 后续优化建议

1. **自动识别**: 录音完成后自动触发识别（无需点击按钮）
2. **实时显示**: 显示识别进度和状态
3. **音频预览**: 录音后可以播放预览
4. **多语言支持**: 支持更多语言识别
5. **噪音过滤**: 自动过滤背景噪音

## 📝 更新记录

- **2024-XX-XX**: 初始版本，完成基础语音转文字功能
- **2024-XX-XX**: 添加自动填入文字输入框功能
- **2024-XX-XX**: 优化错误处理和用户提示

