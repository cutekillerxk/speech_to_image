# è¯­éŸ³é­”æ³•ç”»æ¿ ä»£ç ç»†èŠ‚è¯´æ˜

æœ¬æ–‡æè¿° `onlyimg.py` åŠå…¶ä¾èµ–çš„æ ¸å¿ƒé€»è¾‘ã€å‡½æ•°ç»†èŠ‚ä¸è°ƒç”¨å…³ç³»ï¼Œä¾¿äºå¿«é€Ÿç†è§£å’Œç»´æŠ¤ã€‚

## æ€»ä½“æµç¨‹
```
å½•éŸ³ (Audioç»„ä»¶)
   â†“ change äº‹ä»¶
process_audio_and_generate(audio)
   â†“
doubao_service.audio_to_text()  # è¯­éŸ³è½¬æ–‡å­—
   â†“
doubao_service.text_to_image_gemini()  # æ–‡ç”Ÿå›¾ï¼ˆå¤±è´¥å›é€€è±†åŒ…/å ä½å›¾ï¼‰
   â†“
history_manager.add_record()    # ä¿å­˜å›¾ç‰‡ä¸ç´¢å¼•
   â†“
è¿”å›æ–°å›¾ç‰‡æ›´æ–° image_output
```

## ä»…ä¿ç•™çš„å‰ç«¯æ§ä»¶ï¼ˆonlyimg.pyï¼‰
- å·¦åˆ—ï¼šæ ‡é¢˜ + ä¸‰ä¸ªæŒ‰é’®
  - `â¬…ï¸ ä¸Šä¸€å¼ ` â†’ åˆ‡æ¢ä¸Šä¸€å¼ å†å²
  - `ğŸ™ï¸ å½•åˆ¶`ï¼ˆAudio ç»„ä»¶æŒ‰é’®ï¼Œå½•åˆ¶/ç»“æŸï¼‰â†’ å½•åˆ¶å®Œæˆè§¦å‘å¤„ç†
  - `â¡ï¸ ä¸‹ä¸€å¼ ` â†’ åˆ‡æ¢ä¸‹ä¸€å¼ å†å²
- å³åˆ—ï¼š`image_output` å›¾ç‰‡å±•ç¤ºåŒºåŸŸï¼ˆheight=700ï¼‰

## æ¨¡å—ä¸å‡½æ•°

### 1. onlyimg.py
- å…¨å±€çŠ¶æ€ï¼š`current_image` / `current_text` / `current_record_id`
- `process_audio_and_generate(audio, progress)`  
  - è¾“å…¥ï¼šAudio ç»„ä»¶è¿”å›çš„éŸ³é¢‘ï¼ˆè·¯å¾„æˆ– (sr, data) å…ƒç»„ï¼‰  
  - éŸ³é¢‘ä¿å­˜ï¼šä¼˜å…ˆ `soundfile`ï¼Œå›é€€ `wave`ï¼Œä¿å­˜åˆ° `audio/`  
  - è¯­éŸ³è½¬æ–‡å­—ï¼š`doubao_service.audio_to_text()`ï¼ˆWhisper-1 / DMX STTï¼‰  
  - æ–‡ç”Ÿå›¾ï¼š`doubao_service.text_to_image_gemini()`ï¼ˆGemini 3 Proï¼Œå¤±è´¥å›é€€è±†åŒ…æˆ–å ä½å›¾ï¼‰  
  - ä¿å­˜å†å²ï¼š`history_manager.add_record()`ï¼ˆPNG + history.jsonï¼‰  
  - è¿”å›ï¼š`gr.update(value=image)`ï¼›å¤±è´¥æ—¶è¿”å› `current_image` ä¿æŒç•Œé¢ä¸æ¸…ç©º  
- `get_previous_image()` / `get_next_image()`ï¼šæŒ‰ç´¢å¼•åˆ‡æ¢å†å²å›¾ç‰‡  
- `init_app()`ï¼šå¯åŠ¨æ—¶åŠ è½½æœ€åä¸€å¼ å†å²å›¾ç‰‡  
- å¸ƒå±€ï¼š`Row` å·¦ä¾§ï¼ˆæ ‡é¢˜+æŒ‰é’®ï¼‰/ å³ä¾§å›¾ç‰‡ï¼›å½•åˆ¶ç»“æŸ `.then` é‡ç½®æŒ‰é’®ä¸ºâ€œğŸ™ï¸ å½•åˆ¶â€

### 2. doubao_service.py
- `audio_to_text(audio_file_path)`  
  - STT URL é»˜è®¤ `https://www.dmxapi.com/v1/audio/transcriptions`  
  - files: `{"file": audio_file, "model": (None, "whisper-1")}`  
  - 401 ä¼šæç¤ºæ£€æŸ¥å¯†é’¥ï¼›æ— å¯†é’¥è¿”å›æ¨¡æ‹Ÿæ–‡æ¡ˆ
- `text_to_image_gemini(text, aspect_ratio="1:1", image_size="1K")`  
  - Gemini base_url é»˜è®¤ `https://www.dmxapi.com`ï¼Œæ¨¡å‹ `gemini-3-pro-image-preview`  
  - è§£æ `response.parts.inline_data` â†’ PIL Imageï¼Œè½¬ RGB  
  - å¼‚å¸¸å›é€€åˆ° `text_to_image`ï¼ˆè±†åŒ…ï¼‰ï¼›å†å¤±è´¥å›å ä½å›¾
- `text_to_image(text, use_gemini=False, ...)`  
  - è±†åŒ…æ–‡ç”Ÿå›¾ï¼Œé»˜è®¤æ¨¡å‹ `doubao-seedream-4-0-250828`ï¼Œsize 2Kï¼Œurl/æˆ– b64_json è§£æ  
  - 401 è¯¦ç»†æç¤ºï¼›å¤±è´¥å›å ä½å›¾
- `_mock_text_to_image(text)`ï¼šå ä½å›¾ï¼Œç»˜åˆ¶æ–‡æœ¬ä¸â€œæµ‹è¯•æ¨¡å¼â€æç¤º

### 3. history_manager.py
- `add_record(image, text)`ï¼šä¿å­˜ PNGï¼ˆè½¬ RGBï¼‰ï¼Œå†™å…¥ `history.json`ï¼Œæœ€å¤š 50 æ¡  
- `get_history()` / `get_record(index)` / `get_current_index(record_id)`ï¼šå†å²æŸ¥è¯¢  
- `clear_history()`ï¼šæ¸…ç©ºè®°å½•ä¸å›¾ç‰‡æ–‡ä»¶

### 4. config.py
- è¯»å–ç¯å¢ƒå˜é‡ï¼š`DMX_API_KEY/API_KEY`ï¼Œ`STT_URL`ï¼Œ`TTI_URL`ï¼Œ`GEMINI_BASE_URL/MODEL`  
- ç›®å½•ï¼š`HISTORY_DIR`ï¼Œ`MAX_HISTORY=50`ï¼›å¯åŠ¨æ—¶ç¡®ä¿ç›®å½•å­˜åœ¨

## å…³é”®ç»†èŠ‚
- å½•éŸ³å®Œæˆæ‰è§¦å‘å¤„ç†ï¼›å¤„ç†æœŸé—´å§‹ç»ˆè¿”å› `current_image`ï¼Œé˜²æ­¢å›¾ç‰‡é—ªç©º
- éŸ³é¢‘ä¿å­˜æ”¯æŒ floatâ†’int16 è½¬æ¢ï¼Œå•/åŒå£°é“å†™å…¥ WAV
- API å¤±è´¥æ—¶è‡ªåŠ¨é™çº§ï¼šGemini â†’ è±†åŒ… â†’ å ä½å›¾
- å†å²è®°å½•æŒä¹…åŒ–ï¼šPNG + JSONï¼Œæ”¯æŒä¸Šä¸€å¼ /ä¸‹ä¸€å¼ 

## è¿è¡Œä¸ä¾èµ–
```bash
conda create -n ati python=3.10
conda activate ati
pip install -r speech_to_image/python/requirements.txt

cd speech_to_image/python
python onlyimg.py
```

## ç¯å¢ƒå˜é‡ï¼ˆpython/.env ç¤ºä¾‹ï¼‰
```env
DMX_API_KEY=your_api_key
STT_URL=https://www.dmxapi.com/v1/audio/transcriptions
TTI_URL=https://www.dmxapi.cn/v1/images/generations
GEMINI_BASE_URL=https://www.dmxapi.com
GEMINI_MODEL=gemini-3-pro-image-preview
```

## å·²çŸ¥æ³¨æ„ç‚¹
- è‹¥ STT/TTI 401ï¼Œè¯·æ£€æŸ¥å¯†é’¥æƒé™ä¸å†™æ³•ï¼ˆsk- å¼€å¤´ï¼‰  
- é•¿è€—æ—¶è¯·æ±‚ä»å¯èƒ½çŸ­æš‚å ä½ï¼Œå¯è€ƒè™‘å¯ç”¨ queue/å¼‚æ­¥ä¼˜åŒ–  
- å½•åˆ¶æŒ‰é’®ç”± Audio ç»„ä»¶è‡ªèº«æ§åˆ¶ï¼Œå¤„ç†å®Œæˆåä¼šé‡ç½®ä¸ºâ€œğŸ™ï¸ å½•åˆ¶â€

