"""
DMXAPI Gemini 图像生成示例
使用 Google Gemini API 生成图像，并保存到本地 output 文件夹
"""

from google import genai
from google.genai import types
import os
from datetime import datetime

# ============================================================================
# 配置部分
# ============================================================================

# DMXAPI 密钥和基础 URL
api_key = "sk-TZMyzTFtM0WQvLx9zeR5syNje5CjqnBcNvejposx4CDLl6tC"  # 替换为你的 DMXAPI 密钥
BASE_URL = "https://www.dmxapi.com"

# 创建 Gemini 客户端
client = genai.Client(api_key=api_key, http_options={'base_url': BASE_URL})

# ============================================================================
# 图像生成提示词
# ============================================================================

# 定义图像生成的提示词
prompt = (
    "教室内，一个的国产现代显示器运行语音画图系统，小麦克风放在电脑旁边，屏幕上显示 语音转图片 界面和生成的图画，图片尽量占满电脑屏幕，展台背景简洁，光线充足，写实风格，高清照片质量"
)

# ============================================================================
# 调用 DMXAPI 生成图像
# ============================================================================

response = client.models.generate_content(
    # 模型名称
    model="gemini-3-pro-image-preview",  # 使用 Gemini 3 Pro 图像预览模型

    # 输入内容
    contents=[prompt],

    # 生成配置
    config=types.GenerateContentConfig(
        # response_modalities: 设置响应模态
        # - ['Image']: 仅返回图片，不返回文本
        # - ['Text', 'Image']: 同时返回文本和图片（默认值）
        # gemini-2.5-flash-image 不能使用该参数
        response_modalities=['Image'],

        # image_config: 图像配置选项
        image_config=types.ImageConfig(
            # aspect_ratio: 设置输出图片的宽高比（注意：使用驼峰命名）
            #
            # ┌─────────────────────────────────────────────────────────────────┐
            # │ Gemini 2.5 Flash                                                │
            # ├──────────┬─────────────┬────────┐                               │
            # │ 宽高比    │ 分辨率      │ 令牌    │                               │
            # ├──────────┼─────────────┼────────┤                               │
            # │ 1:1      │ 1024x1024   │ 1290   │                               │
            # │ 2:3      │ 832x1248    │ 1290   │                               │
            # │ 3:2      │ 1248x832    │ 1290   │                               │
            # │ 3:4      │ 864x1184    │ 1290   │                               │
            # │ 4:3      │ 1184x864    │ 1290   │                               │
            # │ 4:5      │ 896x1152    │ 1290   │                               │
            # │ 5:4      │ 1152x896    │ 1290   │                               │
            # │ 9:16     │ 768x1344    │ 1290   │                               │
            # │ 16:9     │ 1344x768    │ 1290   │                               │
            # └──────────┴─────────────┴────────┘                               │
            # └─────────────────────────────────────────────────────────────────┘
            #
            # ┌─────────────────────────────────────────────────────────────────┐
            # │ Gemini 3 Pro Image 预览版                                        │
            # ├──────────┬─────────────────────────────────────────────────────┐│
            # │ 宽高比    │ 1K 分辨率   │ 1K令牌  │ 2K 分辨率   │ 4K 分辨率      ││
            # ├──────────┼─────────────┼────────┼─────────────┼───────────────┤│
            # │ 1:1      │ 1024x1024   │ 1210   │ 2048x2048   │ 4096x4096     ││
            # │ 2:3      │ 848x1264    │ 1210   │ 1696x2528   │ 3392x5056     ││
            # │ 3:2      │ 1264x848    │ 1210   │ 2528x1696   │ 5056x3392     ││
            # │ 3:4      │ 896x1200    │ 1210   │ 1792x2400   │ 3584x4800     ││
            # │ 4:3      │ 1200x896    │ 1210   │ 2400x1792   │ 4800x3584     ││
            # │ 4:5      │ 928x1152    │ 1210   │ 1856x2304   │ 3712x4608     ││
            # │ 5:4      │ 1152x928    │ 1210   │ 2304x1856   │ 4608x3712     ││
            # │ 9:16     │ 768x1376    │ 1210   │ 1536x2752   │ 3072x5504     ││
            # │ 16:9     │ 1376x768    │ 1210   │ 2752x1536   │ 5504x3072     ││
            # │ 21:9     │ 1584x672    │ 1210   │ 3168x1344   │ 6336x2688     ││
            # └──────────┴─────────────┴────────┴─────────────┴───────────────┘│
            # │ 注: 2K/4K 分辨率令牌分别为 1210/2000                             │
            # └─────────────────────────────────────────────────────────────────┘
            #
            aspect_ratio="1:1",

            # image_size: 设置输出图片的分辨率（仅 Gemini 3 Pro Image 预览版支持）
            # - "1K": 1K 分辨率（默认值，所有模型均支持）
            # - "2K": 2K 分辨率（仅 Gemini 3 Pro Image 预览版）
            # - "4K": 4K 分辨率（仅 Gemini 3 Pro Image 预览版）
            # gemini-2.5-flash-image 不能使用该参数
            # image_size="1K",
        ),

        # tools: Google 搜索工具（可选）
        # - 使用实时信息生成图像（如天气预报、股市图表、近期活动等）
        # - 注意: 使用搜索工具时必须设置 response_modalities=['Text', 'Image']
        # - 图片专用模式 ['Image'] 与搜索工具不兼容
        # 示例: tools=[{"google_search": {}}]
        # gemini-2.5-flash-image 不能使用该参数
        # tools=[{"google_search": {}}]
    )
)

# ============================================================================
# 处理响应并保存图像
# ============================================================================

for part in response.parts:
    # 处理文本响应（如果有）
    if part.text is not None:
        print(part.text)

    # 处理图像响应
    elif part.inline_data is not None:
        # 确保 output 文件夹存在
        os.makedirs("output", exist_ok=True)

        # 生成带时间戳的文件名
        # 格式: generated_image_20250121_143052.png (年月日_时分秒)
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"output/generated_image_{timestamp}.png"

        # 将响应数据转换为 PIL Image 对象
        image = part.as_image()

        # 保存图像到文件
        image.save(filename)

        # 输出保存成功的提示信息
        print(f"图片已保存到 {filename}")