# è¯­éŸ³è½¬å›¾ç‰‡ç”Ÿæˆå™¨ Demo è¯´æ˜æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Python + Gradio çš„è¯­éŸ³è½¬å›¾ç‰‡ç”Ÿæˆå™¨ï¼Œå®ç°äº†å®Œæ•´çš„è¯­éŸ³è¾“å…¥ â†’ æ–‡å­—è¯†åˆ« â†’ å›¾ç‰‡ç”Ÿæˆçš„æµç¨‹ã€‚é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼ŒåŠŸèƒ½è§£è€¦ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ–‡ä»¶ç»“æ„

```
python/
â”œâ”€â”€ app.py              # Gradio ä¸»åº”ç”¨ï¼ˆç•Œé¢å’Œäº¤äº’é€»è¾‘ï¼‰
â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†ï¼ˆç¯å¢ƒå˜é‡ã€è·¯å¾„é…ç½®ï¼‰
â”œâ”€â”€ doubao_service.py  # API æœåŠ¡å±‚ï¼ˆéŸ³é¢‘è½¬æ–‡å­—ã€æ–‡å­—è½¬å›¾ç‰‡ï¼‰
â”œâ”€â”€ history_manager.py  # å†å²è®°å½•ç®¡ç†ï¼ˆå›¾ç‰‡ä¿å­˜ã€å†å²æŸ¥è¯¢ï¼‰
â”œâ”€â”€ requirements.txt    # Python ä¾èµ–
â””â”€â”€ .env               # ç¯å¢ƒå˜é‡é…ç½®ï¼ˆéœ€è‡ªè¡Œåˆ›å»ºï¼‰
```

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gradio Web ç•Œé¢ (app.py)        â”‚
â”‚  - ç”¨æˆ·äº¤äº’                              â”‚
â”‚  - äº‹ä»¶ç»‘å®š                              â”‚
â”‚  - çŠ¶æ€ç®¡ç†                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ä¸šåŠ¡é€»è¾‘å±‚ (app.py å‡½æ•°)             â”‚
â”‚  - process_audio() éŸ³é¢‘å¤„ç†             â”‚
â”‚  - generate_image() å›¾ç‰‡ç”Ÿæˆ             â”‚
â”‚  - get_previous/next_image() å†å²æµè§ˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æœåŠ¡å±‚ (doubao_service.py)           â”‚
â”‚  - audio_to_text() è¯­éŸ³è½¬æ–‡å­—           â”‚
â”‚  - text_to_image_gemini() æ–‡å­—è½¬å›¾ç‰‡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ•°æ®å±‚ (history_manager.py)          â”‚
â”‚  - add_record() ä¿å­˜è®°å½•                â”‚
â”‚  - get_history() æŸ¥è¯¢å†å²                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ ¸å¿ƒåŠŸèƒ½æµç¨‹

### 1. è¯­éŸ³è½¬æ–‡å­—æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»å½•éŸ³æŒ‰é’®
    â†“
Gradio Audio ç»„ä»¶å½•éŸ³ï¼ˆtype="numpy"ï¼‰
    â†“
è¿”å› (sample_rate, audio_data) å…ƒç»„
    â†“
process_audio() å‡½æ•°å¤„ç†
    â”œâ”€ ä¿å­˜éŸ³é¢‘åˆ° audio/ ç›®å½•
    â”‚  â”œâ”€ ä¼˜å…ˆä½¿ç”¨ soundfileï¼ˆå¦‚æœå®‰è£…ï¼‰
    â”‚  â””â”€ å›é€€åˆ° wave æ¨¡å—
    â”‚
    â†“
è°ƒç”¨ doubao_service.audio_to_text()
    â”œâ”€ è¯»å–éŸ³é¢‘æ–‡ä»¶
    â”œâ”€ æ„å»º multipart/form-data è¯·æ±‚
    â”‚  â””â”€ files = {"file": audio_file, "model": (None, "whisper-1")}
    â”œâ”€ å‘é€ POST è¯·æ±‚åˆ° DMXAPI
    â”‚  â””â”€ URL: https://www.dmxapi.com/v1/audio/transcriptions
    â””â”€ è§£æå“åº” {"text": "..."}
    â†“
è¿”å›è¯†åˆ«çš„æ–‡å­—
    â†“
è‡ªåŠ¨å¡«å…¥æ–‡å­—è¾“å…¥æ¡†
```

**å…³é”®ç»†èŠ‚**ï¼š
- **éŸ³é¢‘æ ¼å¼å¤„ç†**ï¼šæ”¯æŒ numpy æ•°ç»„å’Œæ–‡ä»¶è·¯å¾„ä¸¤ç§è¾“å…¥
- **æ ¼å¼è½¬æ¢**ï¼šè‡ªåŠ¨å¤„ç† float32/float64 â†’ int16 è½¬æ¢
- **å®¹é”™æœºåˆ¶**ï¼šsoundfile ä¸å¯ç”¨æ—¶è‡ªåŠ¨å›é€€åˆ° wave æ¨¡å—
- **æ–‡ä»¶ç®¡ç†**ï¼šæ‰€æœ‰å½•éŸ³ä¿å­˜åœ¨ `python/audio/` ç›®å½•

### 2. æ–‡å­—è½¬å›¾ç‰‡æµç¨‹

```
ç”¨æˆ·è¾“å…¥æ–‡å­—ï¼ˆæ‰‹åŠ¨è¾“å…¥æˆ–è¯­éŸ³è¯†åˆ«ï¼‰
    â†“
ç‚¹å‡»"ç”Ÿæˆå›¾ç‰‡"æŒ‰é’®
    â†“
generate_image() å‡½æ•°å¤„ç†
    â”œâ”€ éªŒè¯è¾“å…¥ï¼ˆéç©ºæ£€æŸ¥ï¼‰
    â†“
è°ƒç”¨ doubao_service.text_to_image_gemini()
    â”œâ”€ æ£€æŸ¥ Gemini SDK æ˜¯å¦å¯ç”¨
    â”œâ”€ æ£€æŸ¥ Gemini å®¢æˆ·ç«¯æ˜¯å¦åˆå§‹åŒ–
    â”œâ”€ æ„å»ºè¯·æ±‚é…ç½®
    â”‚  â”œâ”€ model: "gemini-3-pro-image-preview"
    â”‚  â”œâ”€ response_modalities: ['Image']
    â”‚  â””â”€ image_config: {aspect_ratio: "1:1", image_size: "1K"}
    â”œâ”€ è°ƒç”¨ Gemini API
    â””â”€ å¤„ç†å“åº”
       â”œâ”€ éå† response.parts
       â”œâ”€ æ£€æŸ¥ part.inline_data
       â”œâ”€ è°ƒç”¨ part.as_image() è½¬æ¢ä¸º PIL Image
       â””â”€ ç¡®ä¿ RGB æ¨¡å¼
    â†“
è¿”å› PIL Image å¯¹è±¡
    â†“
ä¿å­˜åˆ°å†å²è®°å½•
    â”œâ”€ history_manager.add_record()
    â”‚  â”œâ”€ ç”Ÿæˆå”¯ä¸€ IDï¼ˆæ—¶é—´æˆ³æ¯«ç§’ï¼‰
    â”‚  â”œâ”€ ä¿å­˜å›¾ç‰‡åˆ° history/{id}.png
    â”‚  â”œâ”€ åˆ›å»ºè®°å½•å¯¹è±¡
    â”‚  â””â”€ æ›´æ–° history.json
    â”‚
    â””â”€ æ›´æ–°å…¨å±€çŠ¶æ€
       â”œâ”€ current_image
       â”œâ”€ current_text
       â””â”€ current_record_id
    â†“
Gradio ç•Œé¢æ˜¾ç¤ºå›¾ç‰‡
```

**å…³é”®ç»†èŠ‚**ï¼š
- **è‡ªåŠ¨å›é€€**ï¼šGemini SDK ä¸å¯ç”¨æ—¶è‡ªåŠ¨å›é€€åˆ° Doubao æ¨¡å‹
- **å›¾ç‰‡æ ¼å¼å¤„ç†**ï¼šç¡®ä¿è¿”å›æ ‡å‡† PIL Imageï¼Œè½¬æ¢ä¸º RGB æ¨¡å¼
- **é”™è¯¯å¤„ç†**ï¼šAPI è°ƒç”¨å¤±è´¥æ—¶è¿”å›å ä½å›¾ç‰‡ï¼Œä¿è¯ç•Œé¢å¯ç”¨

### 3. å†å²è®°å½•ç®¡ç†æµç¨‹

```
ç”Ÿæˆå›¾ç‰‡å
    â†“
history_manager.add_record(image, text)
    â”œâ”€ ç”Ÿæˆå”¯ä¸€ ID: int(time.time() * 1000)
    â”œâ”€ ä¿å­˜å›¾ç‰‡: history/{id}.png
    â”‚  â””â”€ ç¡®ä¿ RGB æ¨¡å¼ï¼Œè‡ªåŠ¨è¯†åˆ«æ ¼å¼
    â”œâ”€ åˆ›å»ºè®°å½•:
    â”‚  {
    â”‚    'id': record_id,
    â”‚    'text': text,
    â”‚    'image_path': image_path,
    â”‚    'timestamp': datetime.now().isoformat()
    â”‚  }
    â”œâ”€ æ·»åŠ åˆ°å†å²åˆ—è¡¨
    â””â”€ ä¿å­˜åˆ° history.json
    â”‚  â””â”€ é™åˆ¶æœ€å¤š 50 æ¡ï¼ˆè‡ªåŠ¨åˆ é™¤æœ€æ—§çš„ï¼‰
    â†“
å†å²æµè§ˆ
    â”œâ”€ get_previous_image() ä¸Šä¸€å¼ 
    â”‚  â””â”€ æ ¹æ® current_record_id æŸ¥æ‰¾ç´¢å¼•
    â”‚  â””â”€ ç´¢å¼• -1ï¼ŒåŠ è½½å›¾ç‰‡
    â”‚
    â””â”€ get_next_image() ä¸‹ä¸€å¼ 
       â””â”€ æ ¹æ® current_record_id æŸ¥æ‰¾ç´¢å¼•
       â””â”€ ç´¢å¼• +1ï¼ŒåŠ è½½å›¾ç‰‡
```

**å…³é”®ç»†èŠ‚**ï¼š
- **å”¯ä¸€ ID**ï¼šä½¿ç”¨æ—¶é—´æˆ³æ¯«ç§’ï¼Œé¿å…å†²çª
- **è‡ªåŠ¨æ¸…ç†**ï¼šæœ€å¤šä¿å­˜ 50 æ¡ï¼Œè¶…å‡ºè‡ªåŠ¨åˆ é™¤æœ€æ—§çš„
- **æŒä¹…åŒ–å­˜å‚¨**ï¼šJSON æ–‡ä»¶ + PNG å›¾ç‰‡æ–‡ä»¶
- **ç´¢å¼•ç®¡ç†**ï¼šæ”¯æŒæ­£å‘å’Œè´Ÿå‘ç´¢å¼•æŸ¥æ‰¾

## ğŸ“ å„æ–‡ä»¶è¯¦ç»†è¯´æ˜

### 1. config.py - é…ç½®ç®¡ç†

**èŒè´£**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®é¡¹ï¼ŒåŒ…æ‹¬ç¯å¢ƒå˜é‡ã€è·¯å¾„ã€API åœ°å€ç­‰ã€‚

**å…³é”®é…ç½®**ï¼š

```python
# API å¯†é’¥ï¼ˆæ”¯æŒä¸¤ç§æ–¹å¼ï¼‰
DOUBAO_API_KEY = os.getenv('DMX_API_KEY') or os.getenv('API_KEY', '')

# API ç«¯ç‚¹
STT_URL = 'https://www.dmxapi.com/v1/audio/transcriptions'  # è¯­éŸ³è½¬æ–‡å­—
TTI_URL = 'https://www.dmxapi.cn/v1/images/generations'    # æ–‡å­—è½¬å›¾ç‰‡ï¼ˆDoubaoï¼‰
GEMINI_BASE_URL = 'https://www.dmxapi.com'                 # Gemini åŸºç¡€ URL
GEMINI_MODEL = 'gemini-3-pro-image-preview'                # Gemini æ¨¡å‹

# åº”ç”¨é…ç½®
HISTORY_DIR = 'python/history'  # å†å²è®°å½•ç›®å½•
MAX_HISTORY = 50                 # æœ€å¤šä¿å­˜ 50 æ¡
```

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ `python-dotenv` è‡ªåŠ¨åŠ è½½ `.env` æ–‡ä»¶
- æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤å€¼
- è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ç›®å½•

### 2. doubao_service.py - API æœåŠ¡å±‚

**èŒè´£**ï¼šå°è£…æ‰€æœ‰å¤–éƒ¨ API è°ƒç”¨ï¼Œæä¾›ç»Ÿä¸€çš„æ¥å£ã€‚

#### 2.1 åˆå§‹åŒ–é€»è¾‘

```python
def __init__(self):
    # åŠ è½½é…ç½®
    self.api_key = config.DOUBAO_API_KEY
    self.stt_url = config.STT_URL
    self.gemini_base_url = config.GEMINI_BASE_URL
    
    # åˆå§‹åŒ– Gemini å®¢æˆ·ç«¯ï¼ˆå¯é€‰ï¼‰
    if GEMINI_AVAILABLE and self.has_api_key:
        self.gemini_client = genai.Client(
            api_key=self.api_key,
            http_options={'base_url': self.gemini_base_url}
        )
```

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- **å¯é€‰ä¾èµ–**ï¼šGemini SDK æœªå®‰è£…æ—¶ä¸å½±å“å…¶ä»–åŠŸèƒ½
- **ä¼˜é›…é™çº§**ï¼šGemini åˆå§‹åŒ–å¤±è´¥æ—¶è‡ªåŠ¨å›é€€
- **è°ƒè¯•ä¿¡æ¯**ï¼šæ˜¾ç¤º API å¯†é’¥å‰ 10 ä¸ªå­—ç¬¦ï¼Œä¿æŠ¤éšç§

#### 2.2 audio_to_text() - è¯­éŸ³è½¬æ–‡å­—

**è¯·æ±‚æ ¼å¼**ï¼ˆæŒ‰ç…§ DMXAPI æ–‡æ¡£ï¼‰ï¼š
```python
files = {
    "file": audio_file,              # æ–‡ä»¶å¯¹è±¡
    "model": (None, "whisper-1"),   # è¡¨å•å­—æ®µæ ¼å¼
}
headers = {"Authorization": f"Bearer {api_key}"}
response = requests.post(url, headers=headers, files=files)
```

**å“åº”è§£æ**ï¼š
```python
result = response.json()
voice_text = result.get("text", "")
```

**é”™è¯¯å¤„ç†**ï¼š
- HTTP é”™è¯¯ï¼šè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œ401 æ—¶ç»™å‡ºé…ç½®æç¤º
- ç½‘ç»œé”™è¯¯ï¼šè¿”å›å‹å¥½é”™è¯¯æ¶ˆæ¯
- å…¶ä»–å¼‚å¸¸ï¼šæ‰“å°å †æ ˆï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯

#### 2.3 text_to_image_gemini() - Gemini å›¾ç‰‡ç”Ÿæˆ

**è¯·æ±‚æ„å»º**ï¼š
```python
image_config_dict = {"aspect_ratio": aspect_ratio}
if image_size != "1K":  # 1K æ˜¯é»˜è®¤å€¼ï¼Œä¸éœ€è¦è®¾ç½®
    image_config_dict["image_size"] = image_size

response = self.gemini_client.models.generate_content(
    model=self.gemini_model,
    contents=[text],
    config=types.GenerateContentConfig(
        response_modalities=['Image'],
        image_config=types.ImageConfig(**image_config_dict),
    )
)
```

**å“åº”å¤„ç†**ï¼š
```python
for part in response.parts:
    if part.inline_data is not None:
        image = part.as_image()
        # ç¡®ä¿æ˜¯æ ‡å‡† PIL Image
        if not isinstance(image, Image.Image):
            # è½¬æ¢é€»è¾‘...
        # ç¡®ä¿ RGB æ¨¡å¼
        if image.mode != 'RGB':
            image = image.convert('RGB')
        return image, text
```

**å…³é”®ç»†èŠ‚**ï¼š
- **ç±»å‹æ£€æŸ¥**ï¼šç¡®ä¿è¿”å›æ ‡å‡† PIL Image å¯¹è±¡
- **æ¨¡å¼è½¬æ¢**ï¼šç»Ÿä¸€è½¬æ¢ä¸º RGB æ¨¡å¼ï¼Œé¿å…ä¿å­˜é—®é¢˜
- **è‡ªåŠ¨å›é€€**ï¼šå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ° Doubao æ¨¡å‹

#### 2.4 _mock_text_to_image() - æ¨¡æ‹Ÿæ¨¡å¼

**ç”¨é€”**ï¼šAPI å¯†é’¥æœªé…ç½®æˆ–è°ƒç”¨å¤±è´¥æ—¶ï¼Œè¿”å›å ä½å›¾ç‰‡ã€‚

**å®ç°**ï¼š
- åˆ›å»º 1024x1024 ç°è‰²èƒŒæ™¯å›¾ç‰‡
- ä½¿ç”¨ç³»ç»Ÿå­—ä½“ç»˜åˆ¶ç”¨æˆ·è¾“å…¥çš„æ–‡å­—
- æ·»åŠ "æµ‹è¯•æ¨¡å¼"æç¤º

**è®¾è®¡ç›®çš„**ï¼šä¿è¯ç•Œé¢å§‹ç»ˆå¯ç”¨ï¼Œå³ä½¿ API ä¸å¯ç”¨ã€‚

### 3. history_manager.py - å†å²è®°å½•ç®¡ç†

**èŒè´£**ï¼šç®¡ç†ç”Ÿæˆçš„å›¾ç‰‡å†å²è®°å½•ï¼ŒåŒ…æ‹¬ä¿å­˜ã€æŸ¥è¯¢ã€æ¸…ç†ã€‚

#### 3.1 æ•°æ®ç»“æ„

**è®°å½•æ ¼å¼**ï¼š
```python
{
    'id': 1765446887356,                    # æ—¶é—´æˆ³æ¯«ç§’
    'text': 'ä¸€åªå¯çˆ±çš„å°çŒ«',                # æ–‡å­—æè¿°
    'image_path': 'history/1765446887356.png',  # å›¾ç‰‡è·¯å¾„
    'timestamp': '2024-12-11T23:45:12.356'      # ISO æ ¼å¼æ—¶é—´æˆ³
}
```

**å­˜å‚¨æ–¹å¼**ï¼š
- JSON æ–‡ä»¶ï¼š`history/history.json` - å­˜å‚¨è®°å½•ç´¢å¼•
- PNG æ–‡ä»¶ï¼š`history/{id}.png` - å­˜å‚¨å›¾ç‰‡æ–‡ä»¶

#### 3.2 add_record() - æ·»åŠ è®°å½•

**æµç¨‹**ï¼š
1. ç”Ÿæˆå”¯ä¸€ IDï¼ˆæ—¶é—´æˆ³æ¯«ç§’ï¼‰
2. ç¡®ä¿å›¾ç‰‡æ˜¯ RGB æ¨¡å¼
3. ä¿å­˜å›¾ç‰‡åˆ°æ–‡ä»¶ï¼ˆè‡ªåŠ¨è¯†åˆ«æ ¼å¼ï¼‰
4. åˆ›å»ºè®°å½•å¯¹è±¡
5. æ·»åŠ åˆ°å†å²åˆ—è¡¨
6. é™åˆ¶æ•°é‡ï¼ˆä¿ç•™æœ€æ–°çš„ 50 æ¡ï¼‰
7. ä¿å­˜åˆ° JSON æ–‡ä»¶

**å…³é”®ç»†èŠ‚**ï¼š
- **æ ¼å¼å¤„ç†**ï¼š`image.save(path)` ä¸æŒ‡å®šæ ¼å¼ï¼Œè®© PIL è‡ªåŠ¨è¯†åˆ«
- **æ•°é‡é™åˆ¶**ï¼š`limited_history = self.history[-self.max_history:]`
- **åŸå­æ“ä½œ**ï¼šå…ˆä¿å­˜å›¾ç‰‡ï¼Œå†æ›´æ–° JSONï¼Œä¿è¯ä¸€è‡´æ€§

#### 3.3 æŸ¥è¯¢æ–¹æ³•

- `get_history()`ï¼šè¿”å›æ‰€æœ‰å†å²è®°å½•åˆ—è¡¨
- `get_record(index)`ï¼šæ ¹æ®ç´¢å¼•è·å–è®°å½•ï¼ˆæ”¯æŒè´Ÿæ•°ï¼‰
- `get_current_index(record_id)`ï¼šæ ¹æ® ID æŸ¥æ‰¾ç´¢å¼•

**ç´¢å¼•å¤„ç†**ï¼š
```python
if index < 0:
    index = len(self.history) + index  # è´Ÿæ•°ç´¢å¼•è½¬æ¢
```

### 4. app.py - Gradio ä¸»åº”ç”¨

**èŒè´£**ï¼šæ„å»º Web ç•Œé¢ï¼Œå¤„ç†ç”¨æˆ·äº¤äº’ï¼Œåè°ƒå„æ¨¡å—ã€‚

#### 4.1 å…¨å±€çŠ¶æ€ç®¡ç†

```python
current_image = None        # å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡å¯¹è±¡
current_text = ""           # å½“å‰æ–‡å­—æè¿°
current_record_id = None    # å½“å‰è®°å½• ID
```

**è®¾è®¡ç›®çš„**ï¼š
- ä¿æŒç•Œé¢çŠ¶æ€ä¸€è‡´æ€§
- æ”¯æŒå†å²æµè§ˆåŠŸèƒ½
- ç®€åŒ–çŠ¶æ€ä¼ é€’

#### 4.2 process_audio() - éŸ³é¢‘å¤„ç†

**è¾“å…¥å¤„ç†**ï¼š
- **å­—ç¬¦ä¸²è·¯å¾„**ï¼šç›´æ¥ä½¿ç”¨æˆ–å¤åˆ¶åˆ° audio ç›®å½•
- **å…ƒç»„æ ¼å¼**ï¼š`(sample_rate, audio_data)` - ä¿å­˜ä¸º WAV æ–‡ä»¶

**éŸ³é¢‘ä¿å­˜é€»è¾‘**ï¼š
```python
# ä¼˜å…ˆä½¿ç”¨ soundfileï¼ˆæ›´ç®€å•ï¼‰
try:
    import soundfile as sf
    sf.write(audio_path, audio_data, sample_rate)
except ImportError:
    # å›é€€åˆ° wave æ¨¡å—
    # å¤„ç†æ•°æ®ç±»å‹è½¬æ¢ï¼ˆfloat â†’ int16ï¼‰
    # è®¾ç½®å£°é“æ•°ã€é‡‡æ ·å®½åº¦ã€é‡‡æ ·ç‡
```

**å…³é”®ç»†èŠ‚**ï¼š
- **æ ¼å¼è½¬æ¢**ï¼šè‡ªåŠ¨å¤„ç† float32/float64 â†’ int16
- **å®¹é”™æœºåˆ¶**ï¼šå¤šç§ä¿å­˜æ–¹å¼ï¼Œç¡®ä¿å…¼å®¹æ€§
- **æ–‡ä»¶ç®¡ç†**ï¼šç»Ÿä¸€ä¿å­˜åˆ° `audio/` ç›®å½•

#### 4.3 generate_image() - å›¾ç‰‡ç”Ÿæˆ

**æµç¨‹**ï¼š
1. éªŒè¯è¾“å…¥ï¼ˆéç©ºæ£€æŸ¥ï¼‰
2. è°ƒç”¨ Gemini æœåŠ¡ç”Ÿæˆå›¾ç‰‡
3. ä¿å­˜åˆ°å†å²è®°å½•
4. æ›´æ–°å…¨å±€çŠ¶æ€
5. è¿”å›å›¾ç‰‡å’ŒçŠ¶æ€ä¿¡æ¯

**é”™è¯¯å¤„ç†**ï¼š
- æ•è·æ‰€æœ‰å¼‚å¸¸
- è¿”å›å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- æ‰“å°è¯¦ç»†é”™è¯¯ä¿¡æ¯åˆ°æ§åˆ¶å°

#### 4.4 å†å²æµè§ˆåŠŸèƒ½

**get_previous_image()**ï¼š
- æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰å›¾ç‰‡
- è·å–å½“å‰ç´¢å¼•
- æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ç¬¬ä¸€å¼ 
- åŠ è½½ä¸Šä¸€å¼ å›¾ç‰‡
- æ›´æ–°å…¨å±€çŠ¶æ€

**get_next_image()**ï¼š
- ç±»ä¼¼é€»è¾‘ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æœ€åä¸€å¼ 

**çŠ¶æ€æ˜¾ç¤º**ï¼š
```python
status = f"ğŸ“¸ ç¬¬ {current_idx + 1} / {len(history)} å¼ \nğŸ“ {text}"
```

#### 4.5 Gradio ç•Œé¢æ„å»º

**å¸ƒå±€ç»“æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¦ä¾§åˆ—ï¼ˆè¾“å…¥åŒºåŸŸï¼‰                   â”‚
â”‚  - è¯­éŸ³è¾“å…¥                          â”‚
â”‚  - æ–‡å­—è¾“å…¥                          â”‚
â”‚  - ç”ŸæˆæŒ‰é’®                          â”‚
â”‚  - çŠ¶æ€æ˜¾ç¤º                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å³ä¾§åˆ—ï¼ˆè¾“å‡ºåŒºåŸŸï¼‰                   â”‚
â”‚  - å›¾ç‰‡æ˜¾ç¤º                          â”‚
â”‚  - å†å²æµè§ˆæŒ‰é’®                      â”‚
â”‚  - ä¸‹è½½æŒ‰é’®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº‹ä»¶ç»‘å®š**ï¼š
- `recognize_btn.click()` â†’ `process_audio()` â†’ è‡ªåŠ¨å¡«å…¥æ–‡å­—
- `generate_btn.click()` â†’ `generate_image()`
- `prev_btn.click()` â†’ `get_previous_image()`
- `next_btn.click()` â†’ `get_next_image()`
- `app.load()` â†’ `init_app()` åˆå§‹åŒ–åŠ è½½

**åˆå§‹åŒ–é€»è¾‘**ï¼š
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æœ€åä¸€å¼ å†å²è®°å½•
- å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯

## ğŸ”§ ç»†èŠ‚å¤„ç†

### 1. é”™è¯¯å¤„ç†ç­–ç•¥

**åˆ†å±‚é”™è¯¯å¤„ç†**ï¼š
- **API å±‚**ï¼šæ•è· HTTP é”™è¯¯ã€ç½‘ç»œé”™è¯¯ï¼Œè¿”å›å‹å¥½æ¶ˆæ¯
- **ä¸šåŠ¡å±‚**ï¼šæ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œè¿”å›é”™è¯¯çŠ¶æ€
- **ç•Œé¢å±‚**ï¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œä¿æŒç•Œé¢å¯ç”¨

**é™çº§ç­–ç•¥**ï¼š
- Gemini SDK ä¸å¯ç”¨ â†’ å›é€€åˆ° Doubao æ¨¡å‹
- API è°ƒç”¨å¤±è´¥ â†’ è¿”å›å ä½å›¾ç‰‡
- å†å²è®°å½•åŠ è½½å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½

### 2. æ•°æ®æ ¼å¼å¤„ç†

**éŸ³é¢‘æ ¼å¼**ï¼š
- æ”¯æŒ numpy æ•°ç»„ï¼ˆfloat32/float64/int16ï¼‰
- è‡ªåŠ¨è½¬æ¢ä¸º WAV æ ¼å¼
- å¤„ç†å•å£°é“/ç«‹ä½“å£°

**å›¾ç‰‡æ ¼å¼**ï¼š
- ç»Ÿä¸€è½¬æ¢ä¸º RGB æ¨¡å¼
- æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼ï¼ˆPNGã€JPEG ç­‰ï¼‰
- è‡ªåŠ¨è¯†åˆ«æ ¼å¼ä¿å­˜

### 3. æ–‡ä»¶ç®¡ç†

**ç›®å½•ç»“æ„**ï¼š
```
python/
â”œâ”€â”€ audio/          # å½•éŸ³æ–‡ä»¶ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ history/        # å†å²è®°å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ history.json
â”‚   â””â”€â”€ *.png
â””â”€â”€ .env            # ç¯å¢ƒå˜é‡ï¼ˆéœ€æ‰‹åŠ¨åˆ›å»ºï¼‰
```

**æ–‡ä»¶å‘½å**ï¼š
- éŸ³é¢‘æ–‡ä»¶ï¼š`audio_{timestamp}.wav`
- å†å²å›¾ç‰‡ï¼š`{record_id}.png`
- è®°å½• IDï¼šæ—¶é—´æˆ³æ¯«ç§’ï¼ˆå”¯ä¸€æ€§ä¿è¯ï¼‰

### 4. æ€§èƒ½ä¼˜åŒ–

**å†å²è®°å½•é™åˆ¶**ï¼š
- æœ€å¤šä¿å­˜ 50 æ¡ï¼Œè‡ªåŠ¨åˆ é™¤æœ€æ—§çš„
- é¿å…å ç”¨è¿‡å¤šç£ç›˜ç©ºé—´

**å›¾ç‰‡å¤„ç†**ï¼š
- ä½¿ç”¨ PIL é«˜æ•ˆå¤„ç†å›¾ç‰‡
- RGB æ¨¡å¼è½¬æ¢å‡å°‘å†…å­˜å ç”¨

**å¼‚æ­¥å¤„ç†**ï¼š
- Gradio è‡ªåŠ¨å¤„ç†å¼‚æ­¥è¯·æ±‚
- ä¸é˜»å¡ç•Œé¢æ“ä½œ

### 5. å®‰å…¨æ€§è€ƒè™‘

**API å¯†é’¥ä¿æŠ¤**ï¼š
- ä½¿ç”¨ `.env` æ–‡ä»¶å­˜å‚¨ï¼Œä¸æäº¤åˆ°ä»£ç ä»“åº“
- è°ƒè¯•ä¿¡æ¯åªæ˜¾ç¤ºå‰ 10 ä¸ªå­—ç¬¦

**è¾“å…¥éªŒè¯**ï¼š
- æ–‡å­—è¾“å…¥éç©ºæ£€æŸ¥
- éŸ³é¢‘æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
- ç´¢å¼•è¾¹ç•Œæ£€æŸ¥

## ğŸ“Š æ•°æ®æµå›¾

### å®Œæ•´æµç¨‹

```
ç”¨æˆ·æ“ä½œ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gradio ç•Œé¢ (app.py)                â”‚
â”‚  - æ¥æ”¶ç”¨æˆ·è¾“å…¥                      â”‚
â”‚  - è§¦å‘äº‹ä»¶                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡é€»è¾‘ (app.py å‡½æ•°)              â”‚
â”‚  - process_audio()                  â”‚
â”‚  - generate_image()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API æœåŠ¡ (doubao_service.py)        â”‚
â”‚  - audio_to_text()                  â”‚
â”‚  - text_to_image_gemini()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤–éƒ¨ API                            â”‚
â”‚  - DMXAPI (Whisper-1)               â”‚
â”‚  - DMXAPI (Gemini 3 Pro)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®æŒä¹…åŒ– (history_manager.py)     â”‚
â”‚  - ä¿å­˜å›¾ç‰‡                          â”‚
â”‚  - ä¿å­˜è®°å½•                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç•Œé¢æ›´æ–° (Gradio)                   â”‚
â”‚  - æ˜¾ç¤ºå›¾ç‰‡                          â”‚
â”‚  - æ›´æ–°çŠ¶æ€                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

1. **è¯­éŸ³è¾“å…¥**ï¼šç”¨æˆ·é€šè¿‡éº¦å…‹é£å½•éŸ³ï¼Œç³»ç»Ÿè¯†åˆ«ä¸ºæ–‡å­—
2. **æ–‡å­—è¾“å…¥**ï¼šç”¨æˆ·ç›´æ¥è¾“å…¥æ–‡å­—æè¿°
3. **å›¾ç‰‡ç”Ÿæˆ**ï¼šç³»ç»Ÿè°ƒç”¨ Gemini API ç”Ÿæˆå›¾ç‰‡
4. **å†å²æµè§ˆ**ï¼šç”¨æˆ·å¯ä»¥æŸ¥çœ‹ä¹‹å‰ç”Ÿæˆçš„å›¾ç‰‡
5. **å›¾ç‰‡ä¸‹è½½**ï¼šç”¨æˆ·å¯ä»¥ä¸‹è½½å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡

## ğŸ” è°ƒè¯•å’Œæ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **API å¯†é’¥æ— æ•ˆ**ï¼š
   - æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `DMX_API_KEY`
   - ç¡®è®¤å¯†é’¥æ ¼å¼æ­£ç¡®ï¼ˆ`sk-` å¼€å¤´ï¼‰
   - æŸ¥çœ‹æ§åˆ¶å° 401 é”™è¯¯æç¤º

2. **Gemini SDK æœªå®‰è£…**ï¼š
   - è¿è¡Œ `pip install google-genai`
   - ç³»ç»Ÿä¼šè‡ªåŠ¨å›é€€åˆ° Doubao æ¨¡å‹

3. **éŸ³é¢‘è¯†åˆ«å¤±è´¥**ï¼š
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ç¡®è®¤éŸ³é¢‘æ–‡ä»¶æ ¼å¼æ­£ç¡®
   - æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

4. **å›¾ç‰‡ç”Ÿæˆå¤±è´¥**ï¼š
   - æ£€æŸ¥ API å¯†é’¥æ˜¯å¦æœ‰æ•ˆ
   - æŸ¥çœ‹æ§åˆ¶å°è¯¦ç»†é”™è¯¯ä¿¡æ¯
   - ç³»ç»Ÿä¼šè‡ªåŠ¨è¿”å›å ä½å›¾ç‰‡

### æ—¥å¿—è¾“å‡º

ç³»ç»Ÿä¼šåœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š
- âœ… æˆåŠŸæ“ä½œ
- âš ï¸ è­¦å‘Šä¿¡æ¯
- âŒ é”™è¯¯ä¿¡æ¯
- ğŸ”— API è¯·æ±‚ URL
- ğŸ“ æç¤ºè¯å†…å®¹

## ğŸ“ æ€»ç»“

è¿™ä¸ª Demo å®ç°äº†å®Œæ•´çš„è¯­éŸ³è½¬å›¾ç‰‡åŠŸèƒ½ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šåŠŸèƒ½è§£è€¦ï¼Œæ˜“äºç»´æŠ¤
2. **å®¹é”™æœºåˆ¶**ï¼šå¤šå±‚é”™è¯¯å¤„ç†ï¼Œä¿è¯å¯ç”¨æ€§
3. **ç”¨æˆ·å‹å¥½**ï¼šç®€æ´çš„ç•Œé¢ï¼Œæ¸…æ™°çš„çŠ¶æ€æç¤º
4. **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½ï¼ˆå¦‚æ¨¡å‹é€‰æ‹©ã€å‚æ•°è°ƒæ•´ï¼‰
5. **æ•°æ®æŒä¹…åŒ–**ï¼šè‡ªåŠ¨ä¿å­˜å†å²è®°å½•ï¼Œæ”¯æŒæµè§ˆ

æ•´ä¸ªç³»ç»Ÿè®¾è®¡è€ƒè™‘äº†å®é™…ä½¿ç”¨ä¸­çš„å„ç§æƒ…å†µï¼ŒåŒ…æ‹¬é”™è¯¯å¤„ç†ã€æ ¼å¼è½¬æ¢ã€æ–‡ä»¶ç®¡ç†ç­‰ç»†èŠ‚ï¼Œç¡®ä¿ç¨³å®šå¯é çš„è¿è¡Œã€‚

